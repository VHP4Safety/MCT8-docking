<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predict binding to mct8 - VHP4Safety</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.dataTables.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>

    <!-- 3Dmol.js Library -->
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
</head>
<body>
    <!-- Logo -->
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="VHP4Safety Logo" class="center">

    <!-- Header -->
    <header>
        <h1>MCT8 Binding Affinity Prediction</h1>
        <p>Assess binding affinity to Monocarboxylate Transporter 8 (MCT8)</p>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-navigation" role="tablist">
        <button class="tab-button active"
                id="tab-docking"
                data-tab="docking"
                role="tab"
                aria-selected="true"
                aria-controls="docking-panel"
                onclick="switchTab('docking')">
            Docking
        </button>
        <button class="tab-button"
                id="tab-documentation"
                data-tab="documentation"
                role="tab"
                aria-selected="false"
                aria-controls="documentation-panel"
                onclick="switchTab('documentation')">
            Documentation
        </button>
    </nav>

    <!-- Tab Content Wrapper -->
    <div class="tab-content-wrapper">

        <!-- Docking Tab Panel -->
        <div id="docking-panel" class="tab-panel active" role="tabpanel" aria-labelledby="tab-docking">

    <!-- Main Container -->
    <div class="container">
        <h2>Input Ligands</h2>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Error Display -->
        {% if error %}
            <div class="error-message">
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}

        <!-- Docking Form -->
        <form method="post" action="/dock" enctype="multipart/form-data" id="dockingForm">
            <!-- SMILES Input -->
            <div class="form-group">
                <label for="smiles">SMILES Strings (comma-separated):</label>
                <input type="text"
                       id="smiles"
                       name="smiles"
                       value="COC1=C(C=CC(=C1)[C@H]2[C@@H](C3=C(O2)C(=CC(=C3)[C@@H]4[C@H](C(=O)C5=C(C=C(C=C5O4)O)O)O)O)CO)O"
                       placeholder="COC1=C(C=CC(=C1)[C@H]2[C@@H]..., c1ccccc1, ..."
                       class="form-control">
                <small>Default: Silychristin (MCT8 inhibitor)</small>
            </div>

            <!-- File Upload -->
            <div class="form-group">
                <label for="file">Or upload file:</label>
                <input type="file"
                       id="file"
                       name="file"
                       accept=".sdf,.smi,.csv,.txt"
                       class="form-control-file">
                <small>Accepted formats: SDF, SMI, CSV (with 'SMILES' column), TXT</small>
            </div>

            <!-- Ligand Processing Options -->
            <div class="options-section">
                <h3>Ligand Preparation</h3>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="add_h" checked>
                        <span>Add Hydrogens</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="gen_3d" checked>
                        <span>Generate 3D Structure</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="optimize" checked>
                        <span>Optimize Geometry</span>
                    </label>
                </div>
            </div>

            <!-- Docking Parameters -->
            <div class="params-section">
                <h3>Docking Parameters</h3>
                <div class="params-grid">
                    <div class="param-item">
                        <label for="num_modes">Number of Poses: <span id="num_modes_value">3</span></label>
                        <input type="range"
                               id="num_modes"
                               name="num_modes"
                               min="1"
                               max="50"
                               value="3"
                               oninput="document.getElementById('num_modes_value').textContent=this.value">
                    </div>

                    <div class="param-item">
                        <label for="exhaustiveness">Exhaustiveness: <span id="exhaustiveness_value">8</span></label>
                        <input type="range"
                               id="exhaustiveness"
                               name="exhaustiveness"
                               min="2"
                               max="128"
                               step="2"
                               value="8"
                               oninput="document.getElementById('exhaustiveness_value').textContent=this.value">
                    </div>

                    <div class="param-item">
                        <label for="autobox_add">Search Box (Å): <span id="autobox_add_value">6.0</span></label>
                        <input type="range"
                               id="autobox_add"
                               name="autobox_add"
                               min="0"
                               max="10"
                               step="0.2"
                               value="6.0"
                               oninput="document.getElementById('autobox_add_value').textContent=this.value">
                    </div>

                    <div class="param-item">
                        <label for="cnn">CNN Scoring:</label>
                        <select id="cnn" name="cnn" class="form-select">
                            <option value="none" selected>None (Empirical scoring - CPU)</option>
                            <option value="fast">Fast CNN (CPU mode)</option>
                            <option value="default">Default CNN (CPU mode)</option>
                        </select>
                        <small style="color: #666; font-size: 0.85em;">Gnina runs in CPU-only mode (--no_gpu). CNN scoring available but slower on CPU.</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button type="submit" name="action" value="dock" class="btn btn-primary">
                    Run Docking
                </button>
                <button type="submit" name="action" value="report" class="btn btn-secondary">
                    Generate PDF Report
                </button>
            </div>
        </form>
    </div>

    <!-- Results Section -->
    {% if results %}
    <div class="container">
        <h2>Docking Results</h2>

        <!-- Info Panel -->
        <div class="info-panel">
            <h4>Interpretation Guide</h4>
            <ul>
                <li><strong style="color: #E6007E;">Likely Inhibitor:</strong> Affinity &lt; -9.0 kcal/mol</li>
                <li><strong style="color: #FF9500;">Possible Inhibitor:</strong> Affinity -8.0 to -9.0 kcal/mol</li>
                <li><strong style="color: #4CAF50;">Unlikely Inhibitor:</strong> Affinity &gt; -8.0 kcal/mol</li>
            </ul>
            <p><strong>Total Poses:</strong> {{ num_poses }}</p>
            <div class="download-section" style="margin-top: 15px;">
                <a href="/download/sdf" class="btn btn-secondary" style="text-decoration: none;">
                    Download Complete SDF File
                </a>
                <small style="display: block; margin-top: 8px; color: #666;">
                    Contains all {{ num_poses }} docked poses with 3D coordinates
                </small>
            </div>
        </div>

        <!-- Results Table -->
        <div class="table-responsive">
            <table id="resultsTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>Structure</th>
                        <th>SMILES</th>
                        <th>InChIKey</th>
                        <th>Affinity (kcal/mol)</th>
                        <th>CNN Score</th>
                        <th>Boltzmann Weight</th>
                        <th>Assessment</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr onclick="showPose({{ loop.index0 }})" class="clickable-row" style="cursor: pointer;">
                        <td>
                            {% if row.structure_img %}
                                <img src="{{ row.structure_img }}"
                                     alt="Structure"
                                     style="max-width: 150px; max-height: 150px;">
                            {% else %}
                                <span>N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ row.smiles }}</td>
                        <td>{{ row.inchikey }}</td>
                        <td>{{ "%.2f"|format(row.affinity) if row.affinity else 'N/A' }}</td>
                        <td>{{ "%.3f"|format(row.cnn_score) if row.cnn_score else 'N/A' }}</td>
                        <td>{{ "%.3f"|format(row.boltzmann_weight) if row.boltzmann_weight else 'N/A' }}</td>
                        <td>
                            {% if row.assessment %}
                                <span class="badge" style="background-color: {{ row.assessment.color }}; color: white;">
                                    {{ row.assessment.category }}
                                </span>
                            {% else %}
                                <span>Unknown</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

        </div> <!-- End docking-panel -->

        <!-- Documentation Tab Panel -->
        <div id="documentation-panel" class="tab-panel" role="tabpanel" aria-labelledby="tab-documentation">
            <div class="documentation-container">
                <!-- Sidebar Navigation -->
                <aside class="doc-sidebar">
                    <nav class="doc-nav">
                        <h3>Contents</h3>
                        <ul>
                            <li><a href="#getting-started" class="doc-link">Getting Started</a></li>
                            <li><a href="#input-guide" class="doc-link">Input Guide</a></li>
                            <li><a href="#parameters" class="doc-link">Docking Parameters</a></li>
                            <li><a href="#results" class="doc-link">Results Interpretation</a></li>
                            <li><a href="#viewer-3d" class="doc-link">3D Viewer Help</a></li>
                            <li><a href="#api" class="doc-link">API Documentation</a></li>
                            <li><a href="#troubleshoot" class="doc-link">Troubleshooting</a></li>
                            <li><a href="#about" class="doc-link">About</a></li>
                        </ul>
                    </nav>
                </aside>

                <!-- Main Documentation Content -->
                <article class="doc-content">
                    <h2>MCT8 Docking Documentation</h2>

                    <!-- Getting Started -->
                    <h3 id="getting-started">Getting Started</h3>
                    <div class="info-box">
                        <p><strong>What is this tool?</strong> This web application predicts the binding affinity between small molecules and MCT8 (Monocarboxylate Transporter 8), a critical protein in thyroid hormone transport.</p>
                    </div>
                    <h4>Your First Docking Simulation</h4>
                    <ol>
                        <li><strong>Enter a molecule</strong>: Use the default SMILES string or paste your own</li>
                        <li><strong>Set parameters</strong>: Start with defaults (3 poses, exhaustiveness 8)</li>
                        <li><strong>Run docking</strong>: Click "Run Docking" and wait 1-5 minutes</li>
                        <li><strong>Review results</strong>: Check the binding affinity score and assessment</li>
                        <li><strong>Visualize in 3D</strong>: Click any result row to see the binding pose</li>
                    </ol>
                    <p><strong>Quick Tips:</strong> Lower (more negative) binding affinity = stronger binding | Scores below -9.0 kcal/mol indicate likely MCT8 inhibition | Use multi-pose view to compare top 5 binding modes</p>

                    <!-- Input Guide -->
                    <h3 id="input-guide">Input Guide</h3>
                    <h4>SMILES Strings</h4>
                    <p>SMILES (Simplified Molecular Input Line Entry System) is a text notation for molecules.</p>
                    <p><strong>Examples:</strong> <code>CCO</code> (Ethanol) | <code>c1ccccc1</code> (Benzene)</p>
                    <h4>File Upload Formats</h4>
                    <ul>
                        <li><strong>SDF (.sdf)</strong>: Pre-prepared 3D structures (recommended for multiple molecules)</li>
                        <li><strong>SMILES (.smi, .txt)</strong>: One SMILES per line</li>
                        <li><strong>CSV (.csv)</strong>: Must contain a 'SMILES' column</li>
                    </ul>
                    <h4>Ligand Preparation Options</h4>
                    <p><strong>Add Hydrogens:</strong> Essential for accurate docking (keep checked) | <strong>Generate 3D:</strong> Creates 3D coordinates from SMILES (recommended) | <strong>Optimize Geometry:</strong> MMFF force field optimization (recommended)</p>

                    <!-- Parameters -->
                    <h3 id="parameters">Docking Parameters Explained</h3>
                    <h4>Number of Poses (1-50, default: 3)</h4>
                    <p>How many different binding orientations to generate. More poses = better sampling but longer computation time.</p>
                    <h4>Exhaustiveness (2-128, default: 8)</h4>
                    <p>Search thoroughness. Higher values increase accuracy but take longer. Use 8 for standard runs, 16+ for publication-quality results.</p>
                    <h4>Search Box (0-10 Å, default: 6)</h4>
                    <p>Expansion around the binding site. Larger values allow more exploration but increase search space. 6Å is optimal for most cases.</p>
                    <h4>CNN Scoring (none/fast/default, default: none)</h4>
                    <p>Neural network rescoring. Set to "none" for CPU-only mode. Use "fast" or "default" if you have a GPU for improved accuracy.</p>

                    <!-- Results Interpretation -->
                    <h3 id="results">Results Interpretation</h3>
                    <h4>Binding Affinity Scale</h4>
                    <ul>
                        <li><strong style="color: #E6007E;">< -9.0 kcal/mol</strong>: Likely Inhibitor (High developmental risk)</li>
                        <li><strong style="color: #FFA500;">-8.0 to -9.0 kcal/mol</strong>: Possible Inhibitor (Moderate risk)</li>
                        <li><strong style="color: #28A745;">> -8.0 kcal/mol</strong>: Unlikely Inhibitor (Low risk)</li>
                    </ul>
                    <h4>Understanding Scores</h4>
                    <p><strong>Binding Affinity:</strong> Estimated free energy of binding (kcal/mol). More negative = stronger binding = higher likelihood of MCT8 inhibition.</p>
                    <p><strong>CNN Score:</strong> Neural network confidence score (0-1) when CNN scoring is enabled. Higher = more confident prediction.</p>
                    <p><strong>Boltzmann Weight:</strong> Thermodynamic probability of each binding pose. Higher weights indicate more energetically favorable conformations.</p>

                    <!-- 3D Viewer Help -->
                    <h3 id="viewer-3d">3D Viewer Help</h3>
                    <h4>Opening the Viewer</h4>
                    <p>Click any row in the results table to open the 3D molecular viewer showing the receptor, binding site, and ligand pose.</p>
                    <h4>Mouse Controls</h4>
                    <ul>
                        <li><strong>Rotate:</strong> Left-click and drag</li>
                        <li><strong>Zoom:</strong> Scroll wheel or pinch gesture</li>
                        <li><strong>Pan:</strong> Right-click and drag</li>
                    </ul>
                    <h4>Display Options</h4>
                    <p><strong>Show Receptor Cartoon:</strong> Toggle protein backbone visualization | <strong>Show Binding Site:</strong> Highlight key residues in the binding pocket | <strong>Multi-Pose View:</strong> Overlay top 5 poses in different colors for comparison</p>

                    <!-- API Documentation -->
                    <h3 id="api">API Documentation</h3>
                    <h4>Endpoint: POST /api</h4>
                    <p><strong>Request:</strong></p>
                    <pre><code>{
  "smiles": ["CCO", "c1ccccc1"],
  "params": {
    "num_modes": 3,
    "exhaustiveness": 8,
    "autobox_add": 6.0,
    "cnn": "none"
  },
  "format": "json"
}</code></pre>
                    <p><strong>Response:</strong></p>
                    <pre><code>{
  "success": true,
  "num_poses": 6,
  "results": [
    {
      "pose_index": 0,
      "smiles": "CCO",
      "affinity": -5.2,
      "assessment": "Unlikely Inhibitor"
    }
  ]
}</code></pre>
                    <h4>Output Formats</h4>
                    <p><code>"format": "json"</code> - JSON response (default) | <code>"format": "csv"</code> - CSV file | <code>"format": "sdf"</code> - SDF file with 3D structures</p>
                    <h4>Additional Endpoints</h4>
                    <p><code>GET /api/receptor</code> - MCT8 protein structure | <code>GET /api/binding_site</code> - Binding site coordinates | <code>GET /api/pose/{pose_id}</code> - Individual pose data</p>

                    <!-- Troubleshooting -->
                    <h3 id="troubleshoot">Troubleshooting</h3>
                    <h4>Invalid SMILES Error</h4>
                    <p><strong>Solution:</strong> Verify SMILES syntax using a chemical structure editor like PubChem or ChemDraw. Ensure proper capitalization (C vs c for aromatic).</p>
                    <h4>Docking Timeout</h4>
                    <p><strong>Solution:</strong> Reduce exhaustiveness parameter or number of poses. Large molecules may require longer computation time.</p>
                    <h4>3D Viewer Not Loading</h4>
                    <p><strong>Solution:</strong> Ensure WebGL is enabled in your browser. Try a different browser (Chrome/Firefox recommended). Clear browser cache.</p>
                    <h4>Multi-Pose Colors Not Showing</h4>
                    <p><strong>Solution:</strong> Ensure you've run docking first. Toggle the multi-pose checkbox. If issues persist, refresh the page and try again.</p>
                    <h4>CSV Upload Format Error</h4>
                    <p><strong>Solution:</strong> Ensure your CSV has a column named exactly "SMILES" (case-sensitive). One SMILES string per row.</p>
                    <h4>Docker Container Won't Start</h4>
                    <p><strong>Solution:</strong> Check if port 5000 is already in use: <code>lsof -i :5000</code>. View logs: <code>docker logs mct8-docking-app</code></p>

                    <!-- About -->
                    <h3 id="about">About This Tool</h3>
                    <h4>Project Information</h4>
                    <p>The MCT8 Binding Affinity Prediction tool is part of the <strong>Virtual Human Platform for Safety (VHP4Safety)</strong> initiative, developing computational models to predict chemical toxicity and reduce animal testing.</p>
                    <h4>Technology Stack</h4>
                    <p><strong>Backend:</strong> Python 3.10+, Flask, RDKit | <strong>Docking Engine:</strong> Gnina v1.3 | <strong>Frontend:</strong> HTML5, JavaScript, 3Dmol.js | <strong>Deployment:</strong> Docker (CPU-only)</p>
                    <h4>Citation</h4>
                    <p>[TO-DO]</p>
                    <h4>Contact</h4>
                    <p><strong>Website:</strong> <a href="https://www.vhp4safety.nl/" target="_blank">www.vhp4safety.nl</a> | <strong>GitHub:</strong> <a href="https://github.com/VHP4Safety" target="_blank">github.com/VHP4Safety</a></p>
                    <div class="warning-box">
                        <strong>Disclaimer:</strong> This tool provides computational predictions for research purposes. Results should be validated experimentally before making regulatory or clinical decisions.
                    </div>
                </article>
            </div>
        </div>

    </div> <!-- End tab-content-wrapper -->

    <!-- Footer -->
    <footer>
        <p>VHP4Safety - Thyroid Case Study | MCT8 Docking Service</p>
        <a href="https://github.com/VHP4Safety" target="_blank">
            <img src="{{ url_for('static', filename='img/github.svg') }}" alt="GitHub" style="width: 20px; vertical-align: middle;">
            View on GitHub
        </a>
    </footer>

    <!-- JavaScript for DataTables -->
    <script>
        $(document).ready(function() {
            {% if results %}
            $('#resultsTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'csvHtml5',
                        text: 'Export CSV',
                        title: 'MCT8_Docking_Results'
                    },
                    {
                        extend: 'excelHtml5',
                        text: 'Export Excel',
                        title: 'MCT8_Docking_Results'
                    },
                    {
                        extend: 'print',
                        text: 'Print'
                    }
                ],
                scrollX: true,
                order: [[3, 'asc']],  // Sort by affinity (ascending, most negative first)
                columnDefs: [
                    { targets: [1], visible: false },  // Hide SMILES column
                    { targets: [2], visible: true }    // Show InChIKey
                ],
                pageLength: 25
            });
            {% endif %}
        });

        // ========================================
        // 3D Molecular Viewer Implementation
        // ========================================

        let viewer = null;
        let currentPoseData = null;
        let receptorPDB = null;
        let bindingSitePDB = null;
        let multiPoseMode = false;
        let loadedPoses = [];
        const MAX_MULTI_POSES = 5;
        const POSE_COLORS = ['magentaCarbon', 'cyanCarbon', 'yellowCarbon', 'greenCarbon', 'orangeCarbon'];

        function initViewer() {
            const container = document.getElementById('viewer-container');
            container.innerHTML = '';

            const config = {
                backgroundColor: 'white',
                antialias: false,        // Disable antialiasing for performance
                cartoonQuality: 5         // Reduce quality from 10 to 5
            };

            viewer = $3Dmol.createViewer(container, config);
            return viewer;
        }

        async function loadReceptorData() {
            if (receptorPDB && bindingSitePDB) {
                return; // Already cached
            }

            try {
                const receptorResp = await fetch('/api/receptor');
                if (!receptorResp.ok) throw new Error('Failed to load receptor');
                const receptorData = await receptorResp.json();
                receptorPDB = receptorData.pdb;

                const siteResp = await fetch('/api/binding_site');
                if (!siteResp.ok) throw new Error('Failed to load binding site');
                const siteData = await siteResp.json();
                bindingSitePDB = siteData.pdb;
            } catch (error) {
                console.error('Error loading receptor data:', error);
                throw error;
            }
        }

        function renderReceptor() {
            if (!viewer || !receptorPDB) return;

            viewer.addModel(receptorPDB, 'pdb');
            viewer.setStyle({model: 0}, {
                cartoon: {
                    color: '#F5F5DC',
                    thickness: 0.5,
                    opacity: 0.8
                }
            });
        }

        function renderBindingSite() {
            if (!viewer || !bindingSitePDB) return;

            viewer.addModel(bindingSitePDB, 'pdb');
            viewer.setStyle({resn: 'SIT'}, {
                stick: {
                    radius: 0.2,
                    colorscheme: 'orangeCarbon'
                }
            });
        }

        function renderLigand(pdbData, colorScheme = 'magentaCarbon') {
            if (!viewer || !pdbData) return;

            viewer.addModel(pdbData, 'pdb');
            const modelIndex = viewer.getModel().length - 1;  // Get index of just-added model

            viewer.setStyle({model: modelIndex, resn: 'LIG'}, {
                stick: {
                    radius: 0.25,
                    colorscheme: colorScheme
                }
            });
        }

        async function loadMultiplePoses(basePoseId) {
            if (!viewer) {
                console.error('Viewer not initialized');
                return;
            }

            // Show loading state
            console.log(`Loading multi-pose view starting from pose ${basePoseId}...`);

            // Clear existing ligands (keep receptor model 0 and binding site model 1)
            let modelCount = viewer.getModel().length;
            while (modelCount > 2) {
                viewer.removeModel(2); // Always remove the third model (index 2)
                modelCount = viewer.getModel().length;
            }

            loadedPoses = [];
            const promises = [];

            // Fetch up to MAX_MULTI_POSES poses
            for (let i = 0; i < MAX_MULTI_POSES; i++) {
                const poseId = basePoseId + i;
                promises.push(
                    fetch(`/api/pose/${poseId}`)
                        .then(resp => {
                            if (resp.ok) {
                                return resp.json();
                            } else if (resp.status === 404 || resp.status === 400) {
                                // Pose doesn't exist (end of available poses)
                                console.log(`Pose ${poseId} not available (expected if fewer poses generated)`);
                                return null;
                            } else {
                                throw new Error(`HTTP ${resp.status} for pose ${poseId}`);
                            }
                        })
                        .catch(err => {
                            console.warn(`Failed to load pose ${poseId}:`, err.message);
                            return null;
                        })
                );
            }

            // Wait for all fetches to complete
            const results = await Promise.all(promises);

            // Render successfully loaded poses
            let successCount = 0;
            results.forEach((poseData, index) => {
                if (poseData && poseData.pdb) {
                    renderLigand(poseData.pdb, POSE_COLORS[index]);
                    loadedPoses.push({
                        id: basePoseId + index,
                        data: poseData,
                        color: POSE_COLORS[index]
                    });
                    successCount++;
                }
            });

            // Handle edge case: no poses loaded
            if (loadedPoses.length === 0) {
                console.error('No poses could be loaded for multi-pose view');
                alert('Error: No poses available to display. Please try a different pose or run docking again.');
                multiPoseMode = false;
                document.getElementById('toggle-multipose').checked = false;
                return;
            }

            // Update info panel with loaded poses
            updateMultiPoseInfo();

            // Zoom to show all loaded ligands
            viewer.zoomTo({resn: 'LIG'}, 1000);
            viewer.render();

            // User feedback
            console.log(`✓ Multi-pose view: Successfully loaded ${successCount} of ${MAX_MULTI_POSES} requested poses`);
        }

        function updateMultiPoseInfo() {
            const infoBox = document.getElementById('pose-info');

            if (multiPoseMode && loadedPoses.length > 1) {
                // Multi-pose mode: Show all loaded poses with color-coding
                let html = `
                    <div style="background-color: #ffe6f4; border-left: 4px solid #E6007E; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                        <h4 style="margin: 0 0 5px 0; color: #E6007E;">
                            Multi-Pose View Active
                        </h4>
                        <p style="margin: 0; font-size: 0.9em;">
                            Displaying ${loadedPoses.length} binding pose${loadedPoses.length > 1 ? 's' : ''} with different colors
                        </p>
                    </div>
                `;

                loadedPoses.forEach((pose, idx) => {
                    const assessment = pose.data.assessment || {};
                    const colorHex = getColorHex(POSE_COLORS[idx]);
                    const colorName = POSE_COLORS[idx].replace('Carbon', '');

                    html += `
                        <div class="info-row" style="
                            border-left: 4px solid ${colorHex};
                            padding-left: 12px;
                            margin-bottom: 10px;
                            background-color: ${colorHex}15;
                            border-radius: 4px;
                            padding: 8px 8px 8px 12px;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="label" style="color: ${colorHex}; font-weight: bold; font-size: 0.95em;">
                                    ● Pose ${pose.id} (${colorName})
                                </span>
                                <span class="value" style="text-align: right;">
                                    <strong>${pose.data.affinity ? pose.data.affinity.toFixed(2) : 'N/A'}</strong> kcal/mol
                                    <span class="badge" style="
                                        background-color: ${assessment.color || '#999'};
                                        color: white;
                                        margin-left: 8px;
                                        font-size: 0.8em;
                                        padding: 3px 8px;
                                    ">
                                        ${assessment.category || 'Unknown'}
                                    </span>
                                </span>
                            </div>
                        </div>
                    `;
                });

                infoBox.innerHTML = html;

            } else if (loadedPoses.length === 1) {
                // Single pose mode: Use standard info display
                updatePoseInfo(loadedPoses[0].data);
            } else {
                // No poses loaded
                infoBox.innerHTML = '<p style="color: #999;">No pose data available</p>';
            }
        }

        function getColorHex(colorScheme) {
            const colorMap = {
                'magentaCarbon': '#E6007E',
                'cyanCarbon': '#00BCD4',
                'yellowCarbon': '#FFEB3B',
                'greenCarbon': '#4CAF50',
                'orangeCarbon': '#FF9500'
            };
            return colorMap[colorScheme] || '#000000';
        }

        function showLoading() {
            const container = document.getElementById('viewer-container');
            container.innerHTML = `
                <div class="viewer-loading">
                    <div class="spinner"></div>
                    <p>Loading 3D structure...</p>
                </div>
            `;
        }

        async function showPose(poseId) {
            const modal = document.getElementById('viewer-modal');

            try {
                modal.style.display = 'block';
                showLoading();

                await loadReceptorData();

                initViewer();
                renderReceptor();
                renderBindingSite();

                if (multiPoseMode) {
                    await loadMultiplePoses(poseId);
                } else {
                    const response = await fetch(`/api/pose/${poseId}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load pose ${poseId}`);
                    }

                    currentPoseData = await response.json();
                    loadedPoses = [{id: poseId, data: currentPoseData, color: 'magentaCarbon'}];

                    renderLigand(currentPoseData.pdb, 'magentaCarbon');
                    viewer.zoomTo({resn: 'LIG'}, 1000);

                    // Restore single-pose info panel structure if needed
                    const infoBox = document.getElementById('pose-info');
                    if (infoBox && !infoBox.querySelector('#info-smiles')) {
                        infoBox.innerHTML = `
                            <div class="info-row">
                                <span class="label">SMILES:</span>
                                <span id="info-smiles" class="value"></span>
                            </div>
                            <div class="info-row">
                                <span class="label">Affinity:</span>
                                <span id="info-affinity" class="value"></span>
                            </div>
                            <div class="info-row">
                                <span class="label">CNN Score:</span>
                                <span id="info-cnn" class="value"></span>
                            </div>
                            <div class="info-row">
                                <span class="label">Assessment:</span>
                                <span id="info-assessment" class="badge"></span>
                            </div>
                        `;
                    }

                    updatePoseInfo(currentPoseData);
                }

                viewer.render();
            } catch (error) {
                console.error('Error showing pose:', error);
                alert(`Error loading 3D structure: ${error.message}`);
                closeViewer();
            }
        }

        function updatePoseInfo(data) {
            document.getElementById('info-smiles').textContent = data.smiles || 'N/A';

            if (data.affinity !== null && data.affinity !== undefined) {
                document.getElementById('info-affinity').textContent =
                    `${data.affinity.toFixed(2)} kcal/mol`;
            } else {
                document.getElementById('info-affinity').textContent = 'N/A';
            }

            if (data.cnn_score !== null && data.cnn_score !== undefined) {
                document.getElementById('info-cnn').textContent = data.cnn_score.toFixed(3);
            } else {
                document.getElementById('info-cnn').textContent = 'N/A';
            }

            const assessmentEl = document.getElementById('info-assessment');
            if (data.assessment) {
                assessmentEl.textContent = data.assessment.category;
                assessmentEl.style.backgroundColor = data.assessment.color;
            } else {
                assessmentEl.textContent = 'Unknown';
                assessmentEl.style.backgroundColor = '#999999';
            }
        }

        function toggleCartoon() {
            if (!viewer) return;

            const checked = document.getElementById('toggle-cartoon').checked;

            if (checked) {
                viewer.setStyle({model: 0}, {
                    cartoon: {
                        color: '#F5F5DC',
                        thickness: 0.5,
                        opacity: 0.8
                    }
                });
            } else {
                viewer.setStyle({model: 0}, {});
            }

            viewer.render();
        }

        function toggleSite() {
            if (!viewer) return;

            const checked = document.getElementById('toggle-site').checked;

            if (checked) {
                viewer.setStyle({resn: 'SIT'}, {
                    stick: {
                        radius: 0.2,
                        colorscheme: 'orangeCarbon'
                    }
                });
            } else {
                viewer.setStyle({resn: 'SIT'}, {});
            }

            viewer.render();
        }

        function toggleMultiPose() {
            if (!viewer) {
                console.warn('Viewer not initialized - cannot toggle multi-pose mode');
                return;
            }

            const wasMultiPose = multiPoseMode;
            multiPoseMode = document.getElementById('toggle-multipose').checked;

            // Update visual indicator
            const indicator = document.getElementById('multipose-indicator');
            if (indicator) {
                indicator.style.display = multiPoseMode ? 'inline' : 'none';
            }

            // Reload current view in new mode
            if (loadedPoses.length > 0) {
                const basePoseId = loadedPoses[0].id;
                console.log(`Switching to ${multiPoseMode ? 'multi-pose' : 'single-pose'} mode...`);
                showPose(basePoseId); // This will reload viewer with new mode
            } else {
                console.warn('No poses loaded to toggle. Please click a result row first.');
                // Revert checkbox if no poses available
                document.getElementById('toggle-multipose').checked = wasMultiPose;
                multiPoseMode = wasMultiPose;
                if (indicator) {
                    indicator.style.display = wasMultiPose ? 'inline' : 'none';
                }
            }
        }

        function resetView() {
            if (!viewer) return;
            viewer.zoomTo({resn: 'LIG'}, 1000);
            viewer.render();
        }

        // ========================================
        // Tab Navigation System
        // ========================================

        function switchTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active', 'fade-in');
            });

            // Deactivate all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.setAttribute('aria-selected', 'false');
            });

            // Activate selected tab
            const targetPanel = document.getElementById(`${tabName}-panel`);
            const targetButton = document.getElementById(`tab-${tabName}`);

            if (targetPanel && targetButton) {
                targetPanel.classList.add('active', 'fade-in');
                targetButton.classList.add('active');
                targetButton.setAttribute('aria-selected', 'true');
                window.location.hash = tabName;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Handle page load and browser navigation
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.slice(1);
            switchTab(hash === 'documentation' ? 'documentation' : 'docking');
        });

        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash === 'docking' || hash === 'documentation') {
                switchTab(hash);
            }
        });

        // Smooth scrolling for documentation anchor links
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('doc-link')) {
                const href = e.target.getAttribute('href');
                if (href && href.startsWith('#')) {
                    e.preventDefault();
                    const targetElement = document.getElementById(href.substring(1));
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }
        });

        // Mobile: Collapsible sidebar
        if (window.innerWidth <= 768) {
            const docSidebar = document.querySelector('.doc-sidebar');
            const docSidebarTitle = document.querySelector('.doc-sidebar h3');
            if (docSidebar && docSidebarTitle) {
                docSidebarTitle.addEventListener('click', () => {
                    docSidebar.classList.toggle('expanded');
                });
            }
        }

        function closeViewer() {
            const modal = document.getElementById('viewer-modal');
            modal.style.display = 'none';

            if (viewer) {
                viewer.clear();
                viewer = null;
            }

            currentPoseData = null;
            loadedPoses = [];
        }

        window.onclick = function(event) {
            const modal = document.getElementById('viewer-modal');
            if (event.target === modal) {
                closeViewer();
            }
        };

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeViewer();
            }
        });
    </script>

    <!-- 3D Viewer Modal -->
    <div id="viewer-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="viewer-title">3D Molecular Viewer</h3>
                <button class="modal-close" onclick="closeViewer()">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Pose Info Panel -->
                <div id="pose-info" class="info-box">
                    <div class="info-row">
                        <span class="label">SMILES:</span>
                        <span id="info-smiles" class="value"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">Affinity:</span>
                        <span id="info-affinity" class="value"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">CNN Score:</span>
                        <span id="info-cnn" class="value"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">Assessment:</span>
                        <span id="info-assessment" class="badge"></span>
                    </div>
                </div>

                <!-- 3D Viewer Container -->
                <div id="viewer-container" style="width: 100%; height: 600px; position: relative;"></div>

                <!-- Controls Panel -->
                <div class="controls-panel">
                    <label class="control-label" style="position: relative;">
                        <input type="checkbox" id="toggle-multipose" onchange="toggleMultiPose()">
                        <span>Multi-Pose View (Top 5)</span>
                        <span id="multipose-indicator" style="
                            display: none;
                            margin-left: 8px;
                            color: #E6007E;
                            font-size: 1.2em;
                            vertical-align: middle;
                        " title="Multi-pose mode active">●</span>
                    </label>
                    <label class="control-label">
                        <input type="checkbox" id="toggle-cartoon" checked onchange="toggleCartoon()">
                        <span>Show Cartoon</span>
                    </label>
                    <label class="control-label">
                        <input type="checkbox" id="toggle-site" onchange="toggleSite()">
                        <span>Show Binding Site</span>
                    </label>
                    <button class="btn btn-secondary btn-sm" onclick="resetView()">Reset View</button>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeViewer()">Close</button>
            </div>
        </div>
    </div>

</body>
</html>
